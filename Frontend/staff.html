<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Staff - School Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        /* ---------------- THEME & LAYOUT VARIABLES ---------------- */
        :root {
            --sidebar-width: 260px;
            --primary-color: #0d6efd; 
            --bg-color: #f4f7fa; 
            --dark-color: #2c3e50;
            --danger-color: #dc3545;
        }

        body {
            background: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            /* Desktop Default: Content shifted right */
            padding-left: var(--sidebar-width);
            overflow-x: hidden; 
        }

        /* SIDEBAR STYLING */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--dark-color);
            position: fixed;
            left: 0;
            top: 0;
            padding-top: 20px;
            color: white;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            z-index: 1050; /* Above content, for mobile toggle */
            transition: transform 0.3s ease-in-out;
        }

        .sidebar .logo-title {
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 30px;
            padding: 0 25px;
        }

        .sidebar a {
            text-decoration: none;
            color: #bdc3c7;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1rem;
            transition: background 0.2s, color 0.2s;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 4px solid var(--primary-color);
            padding-left: 21px; 
        }
        
        .sidebar .logout-link {
            color: var(--danger-color); 
            margin-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
        }

        /* MAIN CONTENT STYLING (Desktop Default) */
        .content {
            padding: 30px;
            min-height: 100vh;
        }
        
        img.staff-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ddd;
            cursor: pointer;
        }
        
        .top-bar {
            padding: 10px 0;
            margin-bottom: 20px;
        }
        
        /* ---------------- MOBILE RESPONSIVENESS ---------------- */

        @media (max-width: 991px) {
            body {
                padding-left: 0; 
            }
            .sidebar {
                transform: translateX(-260px); 
            }
            #sidebarToggle {
                display: block !important;
            }
            .content {
                padding: 15px; 
            }
            /* Force form filters to stack vertically */
            .card .col-md-6 {
                width: 100%;
                margin-top: 10px;
            }
        }
        
        /* Class added by JS to show sidebar on mobile */
        .sidebar-toggled .sidebar {
            transform: translateX(0);
        }
    </style>
</head>

<body id="page-body">

    <div class="sidebar">
        <div class="logo-title text-center">
            <i class="bi bi-gear-fill me-2"></i> Admin Panel
        </div>
        <a href="index.html"><i class="bi bi-speedometer2"></i> Dashboard</a>
        <a href="standards.html"><i class="bi bi-journals"></i> Standards</a>
        <a href="divisions.html"><i class="bi bi-grid"></i> Divisions</a>
        <a href="students.html"><i class="bi bi-people"></i> Students</a>
        <a class="active" href="staff.html"><i class="bi bi-person-badge"></i> Staff</a>
        <a href="profile.html"><i class="bi bi-person-circle"></i> Profile & Settings</a>
        <a href="#" onclick="logout()" class="logout-link"><i class="bi bi-box-arrow-right"></i> Logout</a>
    </div>


    <div class="content" id="content-wrapper">
        <div class="top-bar d-flex align-items-center">
            <button class="btn btn-outline-dark d-lg-none me-3" id="sidebarToggle">
                <i class="bi bi-list fs-5"></i>
            </button>
            <h2 class="mb-0 text-primary pb-2"><i class="bi bi-person-badge me-2"></i> Manage Staff</h2>
        </div>
        <div class="page-header mb-4 d-flex justify-content-between align-items-center">
            <p class="text-muted mb-0 d-none d-md-block">List of all staff members and their roles.</p>
            <button class="btn btn-primary" onclick="showAddModal()">
                <i class="bi bi-plus-circle-fill me-1"></i> Add Staff
            </button>
        </div>
        
        <div class="card p-3 mb-4 shadow-sm">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="searchName" class="form-label fw-bold">Search by Name/Email</label>
                    <input type="text" id="searchName" class="form-control" placeholder="Enter name or email..." onkeyup="applyFilters()">
                </div>
                <div class="col-md-6">
                    <label for="filterRole" class="form-label fw-bold">Filter by Role</label>
                    <select id="filterRole" class="form-select" onchange="applyFilters()">
                        <option value="">-- All Roles --</option>
                        <option value="Teacher">Teacher</option>
                        <option value="Counselor">Counselor</option>
                        <option value="Librarian">Librarian</option>
                        <option value="Coach">Coach</option>
                        <option value="Support">Support</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
        </div>


        <div class="card p-4 shadow-sm">
            <div class="table-responsive">
                <table class="table table-bordered table-hover bg-white">
                    <thead class="table-dark">
                        <tr>
                            <th>Photo</th>
                            <th>Name</th>
                            <th class="d-none d-md-table-cell">Phone</th> <th class="d-none d-sm-table-cell">Email</th> <th>Role</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="staffTable">
                        <tr><td colspan="6" class="text-center text-muted">Loading staff data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <div class="modal fade" id="staffModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header bg-primary text-white">
                    <h5 id="modalTitle" class="modal-title">Add Staff</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <form id="staffForm">
                        <input type="hidden" id="staffId">

                        <div class="mb-3">
                            <label class="form-label">Name <span class="text-danger">*</span></label>
                            <input id="name" class="form-control" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input id="email" type="email" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input id="phone" class="form-control">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Role <span class="text-danger">*</span></label>
                            <select id="role" class="form-select" required>
                                <option value="">-- Select Role --</option>
                                <option value="Teacher">Teacher</option>
                                <option value="Counselor">Counselor</option>
                                <option value="Librarian">Librarian</option>
                                <option value="Coach">Coach</option>
                                <option value="Support">Support</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Photo (Upload New)</label>
                            <input id="imageFile" type="file" class="form-control" accept="image/*">
                            <small id="imageHint" class="text-muted" style="display: none;">Upload a new image to replace the current photo.</small>
                        </div>
                        
                        <p id="error" class="text-danger fw-bold mt-3"></p>
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="saveButton" class="btn btn-success" onclick="saveStaff()">Save</button>
                </div>

            </div>
        </div>
    </div>
    
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-person-lines-fill me-2"></i>Staff Details</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <img id="detailPhoto" class="staff-img" style="width: 100px; height: 100px; margin-bottom: 10px;">
                        <h4 id="detailName" class="mb-0"></h4>
                        <p class="text-muted" id="detailRole"></p>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Email:</strong> <span id="detailEmail"></span></li>
                        <li class="list-group-item"><strong>Phone:</strong> <span id="detailPhone"></span></li>
                        <li class="list-group-item"><strong>Role:</strong> <span id="detailStaffRole"></span></li>
                        <li class="list-group-item"><strong>ID:</strong> <span id="detailStaffId"></span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="imageViewerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-header border-0 p-2">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <img id="fullImage" src="" alt="Full size staff photo" style="max-height: 90vh;">
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Configuration & Initialization ---
        const API_BASE = "https://school-management-system-vhn2.onrender.com/api";
        const STAFF_URL = `${API_BASE}/staff`;
        const IMAGE_BASE_URL = "https://school-management-system-vhn2.onrender.com/uploads/"; 

        const token = localStorage.getItem("token"); 
        const AUTH_HEADER = { "Authorization": "Bearer " + token };

        // DOM Elements
        const staffModal = new bootstrap.Modal(document.getElementById('staffModal'));
        const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
        const imageViewerModal = new bootstrap.Modal(document.getElementById('imageViewerModal'));
        const modalTitle = document.getElementById('modalTitle');
        const staffTable = document.getElementById('staffTable');
        const staffIdInput = document.getElementById('staffId');
        const saveButton = document.getElementById('saveButton');
        const errorDisplay = document.getElementById('error');
        const imageFile = document.getElementById('imageFile');
        const imageHint = document.getElementById('imageHint');
        const form = document.getElementById('staffForm');
        const pageBody = document.getElementById('page-body'); // For responsive toggle

        // Form & Filter Inputs
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const phoneInput = document.getElementById('phone');
        const roleInput = document.getElementById('role');
        const searchName = document.getElementById('searchName');
        const filterRole = document.getElementById('filterRole');

        // --- Responsive Toggle Logic ---
        document.getElementById("sidebarToggle").addEventListener("click", function (e) {
            e.preventDefault();
            pageBody.classList.toggle("sidebar-toggled");
        });
        
        document.querySelectorAll('.sidebar a').forEach(link => {
            link.addEventListener('click', () => {
                // Auto-hide on link click if on mobile
                if (window.innerWidth < 992) {
                    pageBody.classList.remove('sidebar-toggled');
                }
            });
        });
        // -----------------------------------

        // --- Utility Functions ---

        function showFullImage(imagePath, event) {
            if (event) event.stopPropagation();
            document.getElementById('fullImage').src = imagePath;
            imageViewerModal.show();
        }

        function getFullImageUrl(imagePath) {
            if (imagePath && (imagePath.startsWith("http://") || imagePath.startsWith("https://"))) {
                return imagePath;
            }
            return imagePath ? `${IMAGE_BASE_URL}${imagePath}` : 'https://via.placeholder.com/50?text=ðŸ‘¤'; 
        }
        
        function clearForm() {
            form.reset();
            staffIdInput.value = "";
            modalTitle.textContent = "Add Staff";
            saveButton.textContent = "Save";
            saveButton.classList.replace('btn-warning', 'btn-success');
            imageHint.style.display = 'none';
            errorDisplay.textContent = '';
            imageFile.value = '';
        }

        function logout() {
            localStorage.removeItem("token");
            localStorage.removeItem("schoolName");
            window.location.href = "login.html";
        }
        
        function showAddModal() {
            clearForm();
            staffModal.show();
        }

        // --- Filtering Logic ---

        function applyFilters() {
            const filters = {
                search: searchName.value.trim(),
                role: filterRole.value
            };
            loadStaff(filters);
        }
        
        async function showStaffDetails(staff) {
            document.getElementById('detailPhoto').src = getFullImageUrl(staff.imageUrl);
            document.getElementById('detailName').textContent = staff.name;
            document.getElementById('detailRole').textContent = staff.role;
            document.getElementById('detailStaffRole').textContent = staff.role;
            document.getElementById('detailEmail').textContent = staff.email;
            document.getElementById('detailPhone').textContent = staff.phone || 'N/A';
            document.getElementById('detailStaffId').textContent = staff.id;
            
            detailModal.show();
        }


        // --- CRUD Operations ---

        function renderTable(staffList) {
            staffTable.innerHTML = "";
            if (!staffList || staffList.length === 0) {
                staffTable.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No staff members found matching the criteria.</td></tr>';
                return;
            }

            staffList.forEach(staff => {
                const imgUrl = getFullImageUrl(staff.imageUrl);
                
                const row = document.createElement('tr');
                row.className = 'table-row-clickable';
                row.onclick = () => showStaffDetails(staff);

                row.innerHTML = `
                    <td>
                        <img src="${imgUrl}" alt="${staff.name}" class="staff-img" 
                               onclick="showFullImage('${imgUrl}', event)">
                    </td>
                    <td>${staff.name}</td>
                    <td class="d-none d-md-table-cell">${staff.phone || 'N/A'}</td>
                    <td class="d-none d-sm-table-cell">${staff.email}</td>
                    <td>${staff.role}</td>
                    <td>
                        <button class="btn btn-sm btn-info me-2 text-white" onclick="event.stopPropagation(); editStaff('${staff.id}')">
                            <i class="bi bi-pencil-square"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteStaff('${staff.id}')">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                `;
                staffTable.appendChild(row);
            });
        }

        async function loadStaff(filters = { search: '', role: '' }) {
            if (!token) {
                 staffTable.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Authentication token missing. Please log in.</td></tr>';
                 return;
            }

            staffTable.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Loading staff data...</td></tr>';
            
            const params = new URLSearchParams();
            if (filters.search) params.append('search', filters.search);
            if (filters.role) params.append('role', filters.role); 

            const url = `${STAFF_URL}?${params.toString()}`;

            try {
                const response = await fetch(url, { headers: AUTH_HEADER }); 
                
                if (!response.ok) {
                    const errorJson = await response.json().catch(() => ({}));
                    throw new Error(errorJson.message || `HTTP Error: ${response.status} - Could not retrieve list.`);
                }
                
                const staffList = await response.json();
                renderTable(staffList);

            } catch (error) {
                console.error("Error loading staff:", error);
                staffTable.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Failed to load staff data: ${error.message}</td></tr>`;
            }
        }

        async function editStaff(id) {
            clearForm();
            if (!token || !id) return;

            try {
                // 1. Construct URL safely using the URL constructor for robustness
                const url = new URL(id, STAFF_URL + '/').href; 
                
                const res = await fetch(url, { headers: AUTH_HEADER });
                
                if (!res.ok) {
                    const errorJson = await res.json().catch(() => ({}));
                    let errorMessage = `Failed to fetch staff data. Status: ${res.status}.`;
                    throw new Error(errorJson.message || errorMessage);
                }

                const staff = await res.json();
                
                // 3. Populate form fields 
                staffIdInput.value = staff.id || '';
                nameInput.value = staff.name || ''; 
                emailInput.value = staff.email || '';
                phoneInput.value = staff.phone || '';
                roleInput.value = staff.role || '';

                // 4. Update modal UI
                modalTitle.textContent = `Edit Staff: ${staff.name}`;
                saveButton.textContent = "Update Changes";
                saveButton.classList.replace('btn-success', 'btn-warning');
                imageHint.style.display = 'block';
                imageFile.required = false; 

                staffModal.show();
                
            } catch (error) {
                console.error("Error loading staff for edit:", error);
                alert(`Failed to load staff data for editing: ${error.message}`);
            }
        }

        async function saveStaff() {
            errorDisplay.textContent = '';
            if (!form.reportValidity() || !token) return; 

            const id = staffIdInput.value;
            const method = id ? "PUT" : "POST";
            const url = id ? `${STAFF_URL}/${id}` : STAFF_URL;

            // 1. Create JSON DTO Payload
            const staffDto = {
                name: nameInput.value,
                email: emailInput.value,
                phone: phoneInput.value,
                role: roleInput.value,
            };

            // 2. Build FormData
            const formData = new FormData();
            
            formData.append('data', new Blob([JSON.stringify(staffDto)], { type: 'application/json' }));
            
            const image = imageFile.files[0];
            
            if (image) {
                formData.append('image', image);
            } else if (method === "PUT") {
                // For PUT without a new image, send an empty file part
                formData.append('image', new Blob([""], { type: "application/octet-stream" }));
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: AUTH_HEADER, 
                    body: formData,
                });

                if (!response.ok) {
                    const contentType = response.headers.get("content-type");
                    let errorMsg = `HTTP Error ${response.status}`;
                    if (contentType && contentType.includes("application/json")) {
                        const errorJson = await response.json();
                        errorMsg = errorJson.message || errorJson.error || errorMsg;
                    } 
                    throw new Error(errorMsg);
                }
                
                alert(`Staff ${id ? 'updated' : 'added'} successfully!`);
                staffModal.hide();
                applyFilters();

            } catch (error) {
                console.error("Save error:", error);
                errorDisplay.textContent = `Error: ${error.message.substring(0, 100)}`;
            }
        }

        async function deleteStaff(id) {
            if (!confirm("Are you sure you want to delete this staff member?")) return;
            if (!token) return;

            try {
                const response = await fetch(`${STAFF_URL}/${id}`, {
                    method: "DELETE",
                    headers: AUTH_HEADER
                });

                if (!response.ok) {
                     const errorJson = await response.json().catch(() => ({}));
                     throw new Error(errorJson.message || `Failed to delete staff member. Status: ${response.status}`);
                }
                
                alert("Staff member deleted successfully!");
                applyFilters();

            } catch (error) {
                console.error("Delete error:", error);
                alert(`Error deleting staff member: ${error.message}`);
            }
        }


        // --- Page Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (!token) {
                 // window.location.href = "login.html"; 
            }
            
            window.showAddModal = showAddModal;
            window.saveStaff = saveStaff;
            window.editStaff = editStaff;
            window.deleteStaff = deleteStaff;
            window.logout = logout;
            window.applyFilters = applyFilters;
            window.showStaffDetails = showStaffDetails;
            window.showFullImage = showFullImage;

            applyFilters();
        });

    </script>
</body>
</html>
