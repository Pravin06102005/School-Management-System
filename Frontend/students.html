<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Students - School Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        /* ---------------- THEME & LAYOUT VARIABLES ---------------- */
        :root {
            --sidebar-width: 260px;
            --primary-color: #0d6efd; 
            --bg-color: #f4f7fa; 
            --dark-color: #2c3e50;
            --danger-color: #dc3545;
        }

        body {
            background: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            /* Desktop Default: Content shifted right */
            padding-left: var(--sidebar-width); 
            overflow-x: hidden; /* Prevents horizontal scroll when sidebar is out of view */
        }

        /* SIDEBAR STYLING */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--dark-color);
            position: fixed;
            left: 0;
            top: 0;
            padding-top: 20px;
            color: white;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            z-index: 1050; /* Above everything else */
            transition: transform 0.3s ease-in-out;
        }

        .sidebar .logo-title {
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 30px;
            padding: 0 25px;
        }

        .sidebar a {
            text-decoration: none;
            color: #bdc3c7;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1rem;
            transition: background 0.2s, color 0.2s;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 4px solid var(--primary-color);
            padding-left: 21px; 
        }
        
        .sidebar .logout-link {
            color: var(--danger-color); 
            margin-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
        }

        /* MAIN CONTENT STYLING (Desktop Default) */
        .content {
            padding: 30px;
            min-height: 100vh;
        }
        
        .student-img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ddd;
            cursor: pointer; 
        }
        
        /* New styling for the top bar on mobile */
        .top-bar {
            padding: 10px 0;
            margin-bottom: 20px;
            align-items: center; 
        }
        
        /* ---------------- MOBILE RESPONSIVENESS ---------------- */
        
        @media (max-width: 992px) {
            body {
                padding-left: 0; /* Remove desktop padding */
            }
            .sidebar {
                /* Hide sidebar off-screen to the left */
                transform: translateX(-260px); 
            }
            /* Show the toggle button on small screens */
            #sidebarToggle {
                display: block !important;
            }
            .content {
                padding: 15px; /* Reduced padding for mobile space */
            }
            /* Force form filters to stack vertically */
            .card .col-md-3 {
                width: 100%;
                margin-top: 10px;
            }
            .top-bar h2 {
                font-size: 1.5rem;
                margin-left: 10px;
            }
        }
        
        /* Class added by JS to show sidebar on mobile */
        .sidebar-toggled .sidebar {
            transform: translateX(0);
        }
        /* End Mobile Specific Styles */
    </style>
</head>

<body id="page-body">

    <div class="sidebar">
        <div class="logo-title text-center">
            <i class="bi bi-gear-fill me-2"></i> Admin Panel
        </div>

        <a href="index.html">
            <i class="bi bi-speedometer2"></i> Dashboard
        </a>
        <a href="standards.html">
            <i class="bi bi-journal-check"></i> Standards
        </a>
        <a href="divisions.html">
            <i class="bi bi-collection"></i> Divisions
        </a>
        <a href="students.html" class="active">
            <i class="bi bi-person-bounding-box"></i> Students
        </a>
        <a href="staff.html">
            <i class="bi bi-people"></i> Staff
        </a>
        <a href="profile.html"><i class="bi bi-person-circle"></i> Profile & Settings</a>
        
        <a href="#" onclick="logout()" class="logout-link">
            <i class="bi bi-box-arrow-right"></i> Logout
        </a>
    </div>

    <div class="content" id="content-wrapper">
        <div class="container-fluid p-0">
            
            <div class="top-bar d-flex align-items-center">
                <button class="btn btn-outline-dark d-lg-none me-3" id="sidebarToggle">
                    <i class="bi bi-list fs-5"></i>
                </button>
                <h2 class="mb-0 text-primary pb-2">
                    <i class="bi bi-person-bounding-box me-2"></i>Manage Students
                </h2>
            </div>
            <div class="page-header mb-3 d-flex justify-content-between align-items-center">
                <p class="text-muted mb-0 d-none d-md-block">List of all registered students in the system.</p>
                <button class="btn btn-primary" onclick="showAddModal()">
                    <i class="bi bi-plus-circle-fill me-1"></i> Add Student
                </button>
            </div>

            <div class="card p-3 mb-4 shadow-sm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="searchName" class="form-label fw-bold">Search by Name</label>
                        <input type="text" id="searchName" class="form-control" placeholder="Enter name..." onkeyup="applyFilters()">
                    </div>
                    <div class="col-md-3">
                        <label for="filterStandard" class="form-label fw-bold">Standard</label>
                        <select id="filterStandard" class="form-select" onchange="updateFilterDivisionDropdown(); applyFilters();"></select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterDivision" class="form-label fw-bold">Division</label>
                        <select id="filterDivision" class="form-select" onchange="applyFilters()"></select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterGender" class="form-label fw-bold">Gender</label>
                        <select id="filterGender" class="form-select" onchange="applyFilters()">
                            <option value="">All Genders</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="table-responsive shadow-sm">
                <table class="table table-bordered table-hover bg-white">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Photo</th>
                            <th>Name</th>
                            <th>Standard</th>
                            <th>Division</th>
                            <th>Roll</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentTable">
                        <tr>
                            <td colspan="7" class="text-center text-muted">Loading students...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <nav>
                <ul class="pagination justify-content-center" id="paginationControls">
                    </ul>
            </nav>

        </div>
    </div>


    <div class="modal fade" id="studentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">

                <div class="modal-header bg-primary text-white">
                    <h5 id="modalTitle" class="modal-title">Add Student</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <form id="studentForm">
                        <input type="hidden" id="studentId" value=""> 

                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">Name <span class="text-danger">*</span></label>
                                <input class="form-control" id="name" required>
                            </div>
                            <div class="col">
                                <label class="form-label">DOB <span class="text-danger">*</span></label>
                                <input class="form-control" type="date" id="dob" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">Gender <span class="text-danger">*</span></label>
                                <select id="gender" class="form-control" required>
                                    <option value="">-- Select Gender --</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="col">
                                <label class="form-label">Phone <span class="text-danger">*</span></label>
                                <input class="form-control" id="phone" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">Email</label>
                                <input class="form-control" type="email" id="email">
                            </div>
                            <div class="col">
                                <label class="form-label">Roll Number <span class="text-danger">*</span></label>
                                <input class="form-control" type="number" id="rollNumber" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">Standard <span class="text-danger">*</span></label>
                                <select id="standardDropdown" class="form-control" required></select>
                            </div>
                            <div class="col">
                                <label class="form-label">Division <span class="text-danger">*</span></label>
                                <select id="divisionDropdown" class="form-control" required></select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Photo (Upload New)</label>
                            <input type="file" id="imageFile" class="form-control" accept="image/*">
                            <small id="imageHint" class="text-muted" style="display: none;">Upload a new image to replace the current one.</small>
                        </div>
                        
                        <div id="modalError" class="text-danger mt-3 fw-bold"></div>

                    </form>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Cancel
                    </button>
                    <button class="btn btn-success" id="saveButton" onclick="saveStudent()">
                        <i class="bi bi-save-fill me-1"></i> Save
                    </button>
                </div>

            </div>
        </div>
    </div>


    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-person-lines-fill me-2"></i>Student Details</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <img id="detailPhoto" class="student-img" style="width: 100px; height: 100px; margin-bottom: 10px;">
                        <h4 id="detailName" class="mb-0"></h4>
                        <p class="text-muted" id="detailStandardDiv"></p>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Roll No:</strong> <span id="detailRoll"></span></li>
                        <li class="list-group-item"><strong>Gender:</strong> <span id="detailGender"></span></li>
                        <li class="list-group-item"><strong>DOB:</strong> <span id="detailDOB"></span></li>
                        <li class="list-group-item"><strong>Phone:</strong> <span id="detailPhone"></span></li>
                        <li class="list-group-item"><strong>Email:</strong> <span id="detailEmail"></span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="imageViewerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-header border-0 p-2">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <img id="fullImage" src="" alt="Full size student photo" style="max-height: 90vh;">
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- Configuration & Initialization ---
    const API_BASE = "http://localhost:8080/api";
    const STUDENT_URL = `${API_BASE}/students`;
    const STD_URL = `${API_BASE}/standards`;
    const DIV_URL = `${API_BASE}/divisions`;
    const IMAGE_BASE_URL = "http://localhost:8080/uploads/";

    const token = localStorage.getItem("token") || ""; 
    const headers = { "Authorization": "Bearer " + token };
    // This is used for multipart/form-data requests (image upload), where Content-Type is set automatically by the browser.
    const AUTH_HEADER_MULTIPART = { "Authorization": "Bearer " + token }; 

    // DOM Elements
    const studentModal = new bootstrap.Modal(document.getElementById('studentModal'));
    const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
    const imageViewerModal = new bootstrap.Modal(document.getElementById('imageViewerModal'));
    const studentTable = document.getElementById('studentTable');
    const modalError = document.getElementById('modalError');
    const pageBodyEl = document.getElementById("page-body"); 

    // Form & Inputs
    const form = document.getElementById('studentForm');
    const nameInput = document.getElementById('name');
    const standardDropdown = document.getElementById('standardDropdown');
    const divisionDropdown = document.getElementById('divisionDropdown');

    const searchName = document.getElementById('searchName');
    const filterStandard = document.getElementById('filterStandard');
    const filterDivision = document.getElementById('filterDivision');
    const filterGender = document.getElementById('filterGender');

    const dobInput = document.getElementById('dob');
    const genderInput = document.getElementById('gender');
    const phoneInput = document.getElementById('phone');
    const emailInput = document.getElementById('email');
    const rollNumberInput = document.getElementById('rollNumber');
    const studentIdInput = document.getElementById('studentId');
    const imageFile = document.getElementById('imageFile');
    const imageHint = document.getElementById('imageHint');
    const saveButton = document.getElementById('saveButton');

    let allStandards = [];
    let allDivisions = [];


    /* ---------------------------------------------------
        MOBILE SIDEBAR TOGGLE (FINAL FIXED)
    ---------------------------------------------------- */

    const toggleBtn = document.getElementById("sidebarToggle");
    if (toggleBtn) {
        const toggle = () => {
            pageBodyEl.classList.toggle("sidebar-toggled");
        };
        // Use click event for desktop/mobile browsers
        toggleBtn.addEventListener("click", toggle);
    }

    // Sidebar auto close in mobile on link click
    document.querySelectorAll(".sidebar a").forEach(link => {
        link.addEventListener("click", () => {
            if (window.innerWidth < 992) {
                pageBodyEl.classList.remove("sidebar-toggled");
            }
        });
    });


    /* ---------------------------------------------------
        UTILITY FUNCTIONS
    ---------------------------------------------------- */

    function showFullImage(imagePath, event) {
        if (event) event.stopPropagation();
        document.getElementById('fullImage').src = imagePath;
        imageViewerModal.show();
    }

    function getFullImageUrl(imagePath) {
        if (imagePath && !imagePath.startsWith("http")) {
            return `${IMAGE_BASE_URL}${imagePath}`;
        }
        return imagePath || 'https://via.placeholder.com/45?text=ðŸ‘¤';
    }

    function clearForm() {
        form.reset();
        studentIdInput.value = "";
        modalTitle.textContent = "Add Student";
        saveButton.textContent = "Save";
        saveButton.classList.replace('btn-warning', 'btn-success');
        imageHint.style.display = 'none';
        modalError.textContent = '';
        divisionDropdown.innerHTML = '<option value="">-- Select Division --</option>';
        divisionDropdown.disabled = true;
    }

    function logout() {
        localStorage.removeItem("token");
        window.location.href = "login.html";
    }

    function showAddModal() {
        clearForm();
        studentModal.show();
    }

    function getStandardName(stdId) {
        const standard = allStandards.find(s => s.id === stdId);
        return standard ? standard.name : 'N/A';
    }

    function getDivisionName(divId) {
        const division = allDivisions.find(d => d.id === divId);
        return division ? division.name : 'N/A';
    }

    /* ---------------------------------------------------
        LOAD DROPDOWNS
    ---------------------------------------------------- */
    async function loadDropdowns() {
        try {
            let res = await fetch(STD_URL, { headers });
            allStandards = await res.json();
            
            res = await fetch(DIV_URL, { headers });
            allDivisions = await res.json();

            populateFormStandardDropdown(allStandards);
            populateFilterStandardDropdown(allStandards);
            
        } catch (error) {
            console.error("Error loading dropdowns:", error);
            modalError.textContent = "Failed to load dropdown data.";
        }
    }

    function populateFormStandardDropdown(standards) {
        standardDropdown.innerHTML = '<option value="">-- Select Standard --</option>';
        standards.sort((a, b) => a.level - b.level).forEach(std => {
            standardDropdown.innerHTML += `<option value="${std.id}">${std.name}</option>`;
        });
    }

    function populateFilterStandardDropdown(standards) {
        filterStandard.innerHTML = '<option value="">All Standards</option>';
        standards.sort((a, b) => a.level - b.level).forEach(std => {
            filterStandard.innerHTML += `<option value="${std.id}">${std.name}</option>`;
        });
    }

    function updateFormDivisionDropdown(selectedStandardId, currentDivisionId = null) {
        divisionDropdown.innerHTML = '<option value="">-- Select Division --</option>';

        const filtered = allDivisions.filter(div => div.standardId === selectedStandardId);
        if (filtered.length > 0) {
            filtered.forEach(div =>
                divisionDropdown.innerHTML += `<option value="${div.id}">${div.name}</option>`
            );
            divisionDropdown.disabled = false;
            if (currentDivisionId) divisionDropdown.value = currentDivisionId;
        } else {
            divisionDropdown.disabled = true;
        }
    }
    
    /**
     * FIX: Updates the Division filter dropdown based on the selected standard 
     * and automatically triggers the main filter.
     * @param {boolean} triggerFilter - Whether to call applyFilters() afterward.
     */
    function updateFilterDivisionDropdown(triggerFilter = false) {
        const selectedStandardId = filterStandard.value;
        const currentDivisionId = filterDivision.value;

        // 1. Populate Division Dropdown
        filterDivision.innerHTML = '<option value="">All Divisions</option>';
        
        if (selectedStandardId) {
            const filteredDivisions = allDivisions.filter(div => div.standardId === selectedStandardId);
            filteredDivisions.forEach(div => {
                filterDivision.innerHTML += `<option value="${div.id}">${div.name}</option>`;
            });
        }
        
        // 2. Attempt to restore selection (or clear it if invalid)
        if (currentDivisionId && Array.from(filterDivision.options).some(opt => opt.value === currentDivisionId)) {
             filterDivision.value = currentDivisionId;
        } else {
             filterDivision.value = "";
        }

        // 3. Trigger main table filter (essential for the cascading effect)
        if (triggerFilter) {
            applyFilters();
        }
    }


    /* ---------------------------------------------------
        VIEW STUDENT DETAILS
    ---------------------------------------------------- */
    async function showStudentDetails(studentId) {
        try {
            const res = await fetch(`${STUDENT_URL}/${studentId}`, { headers });
            if (!res.ok) throw new Error(`Status ${res.status}`);

            const student = await res.json();

            document.getElementById('detailPhoto').src = getFullImageUrl(student.imageUrl);
            document.getElementById('detailName').textContent = student.name;
            document.getElementById('detailStandardDiv').textContent =
                `${getStandardName(student.standardId)} - ${getDivisionName(student.divisionId)}`;
            document.getElementById('detailRoll').textContent = student.rollNumber;
            document.getElementById('detailGender').textContent = student.gender;
            document.getElementById('detailDOB').textContent = student.dob;
            document.getElementById('detailPhone').textContent = student.phone;
            document.getElementById('detailEmail').textContent = student.email;

            detailModal.show();
        } catch (error) {
            console.error("Error fetching student:", error);
            alert("Failed to load student details.");
        }
    }


    /* ---------------------------------------------------
        FILTER + TABLE LOAD
    ---------------------------------------------------- */
    function applyFilters() {
        const filters = {
            name: searchName.value.trim(),
            standardId: filterStandard.value,
            divisionId: filterDivision.value,
            gender: filterGender.value,
        };
        loadStudents(filters);
    }

    function renderTable(students) {
        studentTable.innerHTML = "";
        const list = students.content || students;

        if (!list || list.length === 0) {
            studentTable.innerHTML =
                '<tr><td colspan="7" class="text-center text-muted">No students found.</td></tr>';
            return;
        }

        list.forEach((student, index) => {
            const std = allStandards.find(s => s.id === student.standardId) || { name: "N/A" };
            const div = allDivisions.find(d => d.id === student.divisionId) || { name: "N/A" };
            const imgUrl = getFullImageUrl(student.imageUrl);

            const row = document.createElement("tr");
            row.className = "table-row-clickable";
            row.onclick = () => showStudentDetails(student.id);

            row.innerHTML = `
                <td>${index + 1}</td>
                <td><img src="${imgUrl}" class="student-img" onclick="showFullImage('${imgUrl}', event)"></td>
                <td>${student.name}</td>
                <td>${std.name}</td>
                <td>${div.name}</td>
                <td>${student.rollNumber || 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-info text-white" onclick="event.stopPropagation(); editStudent('${student.id}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteStudent('${student.id}')">Delete</button>
                </td>`;
            studentTable.appendChild(row);
        });
    }

    async function loadStudents(filters = {}) {
        studentTable.innerHTML =
            '<tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>';

        const params = new URLSearchParams(filters);
        const url = `${STUDENT_URL}?${params.toString()}`;

        try {
            const response = await fetch(url, { headers });
            if (!response.ok) throw new Error(response.statusText);

            const data = await response.json();
            renderTable(data);

        } catch (error) {
            console.error("Error loading table:", error);
            studentTable.innerHTML =
                '<tr><td colspan="7" class="text-center text-danger">Failed to load.</td></tr>';
        }
    }


    /* ---------------------------------------------------
        EDIT + SAVE STUDENT
    ---------------------------------------------------- */
    async function editStudent(id) {
        clearForm();
        try {
            const res = await fetch(`${STUDENT_URL}/${id}`, { headers });
            if (!res.ok) throw new Error(`Status ${res.status}`);

            const student = await res.json();

            studentIdInput.value = student.id;
            nameInput.value = student.name;
            dobInput.value = student.dob;
            genderInput.value = student.gender;
            phoneInput.value = student.phone;
            emailInput.value = student.email;
            rollNumberInput.value = student.rollNumber;

            standardDropdown.value = student.standardId;
            updateFormDivisionDropdown(student.standardId, student.divisionId);

            modalTitle.textContent = "Edit Student";
            saveButton.textContent = "Update Changes";
            saveButton.classList.replace('btn-success', 'btn-warning');
            imageHint.style.display = 'block';

            studentModal.show();

        } catch (error) {
            console.error("Edit error:", error);
            alert("Failed to load student for editing.");
        }
    }


    async function saveStudent() {
        modalError.textContent = "";
        if (!form.reportValidity()) return;

        const id = studentIdInput.value;
        const method = id ? "PUT" : "POST";
        const url = id ? `${STUDENT_URL}/${id}` : STUDENT_URL;

        const studentDto = {
            name: nameInput.value,
            dob: dobInput.value,
            gender: genderInput.value,
            phone: phoneInput.value,
            email: emailInput.value,
            rollNumber: rollNumberInput.value,
            standardId: standardDropdown.value,
            divisionId: divisionDropdown.value,
        };

        const formData = new FormData();
        formData.append('data', new Blob([JSON.stringify(studentDto)], { type: 'application/json' }));

        const image = imageFile.files[0];
        if (image) formData.append('image', image);

        try {
            const response = await fetch(url, {
                method: method,
                headers: AUTH_HEADER_MULTIPART,
                body: formData,
            });

            if (!response.ok) {
                const err = await response.text();
                throw new Error(err);
            }

            alert(id ? "Student updated!" : "Student added!");
            studentModal.hide();
            applyFilters();

        } catch (error) {
            console.error("Save error:", error);
            modalError.textContent = `Error: ${error.message}`;
        }
    }


    /* ---------------------------------------------------
        DELETE STUDENT
    ---------------------------------------------------- */
    async function deleteStudent(id) {
        if (!confirm("Are you sure?")) return;

        try {
            const res = await fetch(`${STUDENT_URL}/${id}`, {
                method: "DELETE",
                headers: headers
            });

            if (!res.ok) throw new Error("Delete failed");

            alert("Student deleted!");
            applyFilters();

        } catch (error) {
            console.error("Delete error:", error);
            alert("Error deleting student");
        }
    }


    /* ---------------------------------------------------
        SHOW DETAILS
    ---------------------------------------------------- */
    async function showStudentDetails(id) {
        const res = await fetch(`${STUDENT_URL}/${id}`, { headers });
        const st = await res.json();

        document.getElementById("detailPhoto").src = getFullImageUrl(st.imageUrl);
        document.getElementById("detailName").textContent = st.name;
        document.getElementById("detailStandardDiv").textContent =
            `${getStandardName(st.standardId)} - ${getDivisionName(st.divisionId)}`;
        document.getElementById("detailRoll").textContent = st.rollNumber;
        document.getElementById("detailGender").textContent = st.gender;
        document.getElementById("detailDOB").textContent = st.dob;
        document.getElementById("detailPhone").textContent = st.phone;
        document.getElementById("detailEmail").textContent = st.email;

        detailModal.show();
    }


    /* ---------------------------------------------------
        PAGE INITIALIZATION
    ---------------------------------------------------- */

    document.addEventListener("DOMContentLoaded", async () => {

        await loadDropdowns();
        applyFilters(); // Initial load

        // Attach events
        standardDropdown.addEventListener("change", (e) => {
            updateFormDivisionDropdown(e.target.value);
        });
        
        // This handles the filter cascading: when standard changes, divisions update AND filters re-apply
        filterStandard.addEventListener("change", () => {
            updateFilterDivisionDropdown(true); // true = trigger filter after updating divisions
        });
        
        // This handles filtering when division, search, or gender changes
        filterDivision.addEventListener("change", applyFilters);
        searchName.addEventListener("keyup", applyFilters);
        filterGender.addEventListener("change", applyFilters);


        // Expose functions for HTML onclick
        window.showAddModal = showAddModal;
        window.saveStudent = saveStudent;
        window.editStudent = editStudent;
        window.deleteStudent = deleteStudent;
        window.logout = logout;
        window.applyFilters = applyFilters;
        window.showStudentDetails = showStudentDetails;
        window.showFullImage = showFullImage;
        window.updateFilterDivisionDropdown = updateFilterDivisionDropdown; // Expose for initial load logic
    });
</script>


</body>
</html>